<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AWR GenAI Analyzer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }

    #chat-window {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
    }

    #chat-window .user {
      text-align: right;
      font-weight: bold;
    }

    #chat-window .assistant {
      text-align: left;
    }

    .input-group .form-control {
      border-right: none;
    }

    .input-group .btn {
      border-left: none;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">üß† Oracle AWR GenAI Analyzer</h2>

    <!-- Upload Form -->
    <form id="upload-form" class="mb-4">
      <div class="mb-2">
        <label for="awr-file" class="form-label">Upload AWR Report (HTML)</label>
        <input type="file" class="form-control" id="awr-file" name="file" required />
      </div>
      <button class="btn btn-success" type="submit">üì§ Upload</button>
      <p class="mt-2 text-muted" id="upload-status"></p>
    </form>

    <!-- Report Selector -->
    <div class="mb-4">
      <label for="report-id" class="form-label">Select Uploaded Report</label>
      <select class="form-select" id="report-id" required>
        <option value="">üîΩ Select a Report</option>
      </select>
    </div>


    <!-- Chat Output -->
    <div id="chat-window" class="rounded shadow-sm"></div>
    <br>

    <!-- Chat Form -->
    <form id="chat-form" class="mb-3">
      <div class="form-label mb-1">Ask a Question</div>
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          id="user-input"
          placeholder="e.g. What is the top SQL by elapsed time?"
          required
        />
        <button class="btn btn-primary" type="submit" id="send-btn">‚û§</button>
      </div>
    </form>

  </div>

  <script>
    const uploadForm = document.getElementById("upload-form");
    const uploadStatus = document.getElementById("upload-status");
    const chatForm = document.getElementById("chat-form");
    const chatWindow = document.getElementById("chat-window");

    async function loadReportIds() {
      try {
        const resp = await fetch("/reports");
        const reports = await resp.json();
        const dropdown = document.getElementById("report-id");
        dropdown.innerHTML = '<option value="">üîΩ Select a Report</option>';
        reports.reverse().forEach(report => {
          const option = document.createElement("option");
          option.value = report.report_id;
          option.textContent = `${report.report_id} ‚Äî ${report.filename}`;
          dropdown.appendChild(option);
        });
      } catch (err) {
        console.error("Failed to load reports:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", loadReportIds);

    uploadForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const fileInput = document.getElementById("awr-file");
      if (!fileInput.files.length) {
        uploadStatus.innerText = "Please select a file.";
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      uploadStatus.innerText = "Uploading...";
      const resp = await fetch("/upload", {
        method: "POST",
        body: formData,
      });

      const data = await resp.json();
      uploadStatus.innerText = data.message || "Upload complete.";
      await loadReportIds();
    });

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.classList.add("mb-2", role);
      div.innerHTML = `<div>${role === "user" ? "üßë You" : "ü§ñ Assistant"}: ${text.replace(/\n/g, "<br>")}</div>`;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return div;
    }

    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const input = document.getElementById("user-input");
      const reportId = document.getElementById("report-id").value.trim();
      const query = input.value.trim();

      if (!query || !reportId) return;

      appendMessage("user", query);
      input.value = "";

      const assistantMsg = appendMessage("assistant", "‚è± Responding...");

      const startTime = Date.now();
      let seconds = 0;
      const timer = setInterval(() => {
        seconds = ((Date.now() - startTime) / 1000).toFixed(1);
        assistantMsg.innerHTML = `<div>ü§ñ Assistant: ‚è± Responding... ${seconds}s</div>`;
      }, 100);

      const formData = new FormData();
      formData.append("query", query);
      formData.append("report_id", reportId);

      const resp = await fetch("/chat", {
        method: "POST",
        body: formData,
      });

      const data = await resp.json();

      clearInterval(timer);
      const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);

      assistantMsg.innerHTML = `<div>ü§ñ Assistant:<br>${data.answer.replace(/\n/g, "<br>")}<br><br>‚úÖ Time: ${totalTime}s</div>`;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });
  </script>
</body>
</html>

