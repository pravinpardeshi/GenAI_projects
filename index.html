<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AWR Chat Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- optional: include a CSS framework like Bootstrap or Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4 text-center">AWR Report Chat Analyzer</h1>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Upload AWR Report</h5>
        <form id="upload-form">
          <div class="mb-3">
            <input class="form-control" type="file" id="awr-file" accept=".txt,.log,.awr,.pdf,.html">
          </div>
          <button type="submit" class="btn btn-primary">Upload & Process</button>
          <div id="upload-status" class="mt-2"></div>
        </form>
      </div>
    </div>

    <form id="chat-form">
      <input type="text" class="form-control mb-2" id="report-id" placeholder="Report ID (e.g., rpt_abcd1234)" required />
      <input type="text" class="form-control mb-2" id="user-input" placeholder="Ask a question..." required />
      <button class="btn btn-primary" type="submit">Send</button>
    </form>


    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Chat with Report</h5>
        <div id="chat-window" class="border rounded p-3 mb-3 bg-white" style="height: 400px; overflow-y: auto;">
          <!-- chat messages go here -->
        </div>
        <form id="chat-form" class="d-flex">
          <input type="text" class="form-control me-2" id="user-input" placeholder="Ask something about the AWR report..." autocomplete="off">
          <button type="submit" class="btn btn-success">Send</button>
        </form>
      </div>
    </div>

  </div>

<script>
  const uploadForm = document.getElementById("upload-form");
  const uploadStatus = document.getElementById("upload-status");

  uploadForm.addEventListener("submit", async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById("awr-file");
    if (!fileInput.files.length) {
      uploadStatus.innerText = "Please select a file first.";
      return;
    }
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    uploadStatus.innerText = "Uploading...";
    const resp = await fetch("/upload", {
      method: "POST",
      body: formData
    });
    const data = await resp.json();
    uploadStatus.innerText = resp.ok ? data.message : "Upload failed.";
  });

  const chatForm = document.getElementById("chat-form");
  const chatWindow = document.getElementById("chat-window");

  function appendMessage(role, text) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("mb-2");

    if (role === "user") {
      msgDiv.innerHTML = `<strong>You:</strong> ${text}`;
      msgDiv.classList.add("text-end");
    } else {
      msgDiv.innerHTML = `<strong>Assistant:</strong><br>${text.replace(/\n/g, "<br>")}`;
      msgDiv.classList.add("text-start");
    }

    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
    return msgDiv; // return element for further use (e.g., updating)
  }

  chatForm.addEventListener("submit", async function(e) {
    e.preventDefault();

    const input = document.getElementById("user-input");
    const query = input.value.trim();
    if (!query) return;

    appendMessage("user", query);
    input.value = "";

    const assistantMessage = appendMessage("assistant", "⏱ Responding...");

    // Start timer
    let startTime = Date.now();
    let timerInterval;
    let secondsElapsed = 0;

    timerInterval = setInterval(() => {
      secondsElapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      assistantMessage.innerHTML = `<strong>Assistant:</strong><br>⏱ Responding... ${secondsElapsed}s`;
    }, 100);

    // Send request
    const formData = new FormData();
    formData.append("query", query);

    const resp = await fetch("/chat", {
      method: "POST",
      body: formData
    });
    const data = await resp.json();

    // Stop timer and display final message
    clearInterval(timerInterval);
    const finalTime = ((Date.now() - startTime) / 1000).toFixed(2);
    assistantMessage.innerHTML = `<strong>Assistant:</strong><br>${data.answer.replace(/\n/g, "<br>")}<br><br>✅ Response time: ${finalTime}s`;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  });

  const formData = new FormData();
  formData.append("query", query);
  formData.append("report_id", document.getElementById("report-id").value);

</script>


</body>
</html>

